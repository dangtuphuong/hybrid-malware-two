import mysql.connector
import json
from utils.connect_to_db import connect_to_db


def store_metrics(malware_distribution, et_metrics, knn_metrics, hybrid_metrics, model_ids, name='System Testing', created_by='system'):
    try:
        et_model_id = model_ids.get('et', None)
        knn_model_id = model_ids.get('knn', None)
        hybrid_model_id = model_ids.get('hybrid', None)

        # Convert malware distribution to JSON
        malware_distribution_json = malware_distribution.to_json()

        # Establish a connection to the database
        connection = connect_to_db()
        cursor = connection.cursor()

        # Insert model metrics into model_metrics table for each model
        insert_metrics_query = """
        INSERT INTO model_metrics (id, accuracy, `precision`, recall, f1, classification_report)
        VALUES (%s, %s, %s, %s, %s, %s)
        """

        # Insert metrics for ExtraTrees
        if (et_metrics):
            cursor.execute(insert_metrics_query, (
                et_model_id,
                et_metrics['accuracy'],
                et_metrics['precision'],
                et_metrics['recall'],
                et_metrics['f1'],
                et_metrics['classification_report']
            ))

        # Insert metrics for KNN
        if (knn_metrics):
            cursor.execute(insert_metrics_query, (
                knn_model_id,
                knn_metrics['accuracy'],
                knn_metrics['precision'],
                knn_metrics['recall'],
                knn_metrics['f1'],
                knn_metrics['classification_report']
            ))

        # Insert metrics for Hybrid
        if (hybrid_metrics):
            cursor.execute(insert_metrics_query, (
                hybrid_model_id,
                hybrid_metrics['accuracy'],
                hybrid_metrics['precision'],
                hybrid_metrics['recall'],
                hybrid_metrics['f1'],
                hybrid_metrics['classification_report']
            ))

        # Create a report entry in the report table
        insert_report_query = """
        INSERT INTO report (name, et_model_id, knn_model_id, hybrid_model_id, malware_distribution, created_by)
        VALUES (%s, %s, %s, %s, %s, %s)
        """
        cursor.execute(insert_report_query, (name, et_model_id, knn_model_id,
                       hybrid_model_id, malware_distribution_json, created_by))

        # Commit the changes
        connection.commit()

    except mysql.connector.Error as err:
        print(f"Error: {err}")
    finally:
        cursor.close()
        connection.close()

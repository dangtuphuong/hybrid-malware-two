/* eslint-disable react-hooks/exhaustive-deps */
import { useState, useEffect, useMemo } from "react";
import {
  Box,
  Button,
  Typography,
  Paper,
  LinearProgress,
  Autocomplete,
  TextField,
  Snackbar,
  IconButton,
  DialogTitle,
  DialogContent,
  Dialog,
  Link,
} from "@mui/material";
import { CloudArrowUpFill, X } from "react-bootstrap-icons";
import DataService from "../services/data-service";
import AuthService from "../services/auth-service";

const ChainUploadForm = () => {
  const [openDialog, setOpenDialog] = useState(false);
  const [openAlert, setOpenAlert] = useState(false);
  const [loading, setLoading] = useState(false);
  const [options, setOptions] = useState([]);
  const [file, setFile] = useState(null);
  const [modelID, setModelID] = useState(null);
  const [reportName, setReportName] = useState("");
  const [chainName, setChainName] = useState("");
  const [mess, setMess] = useState("");
  const [response, setResponse] = useState(null);

  const user = useMemo(() => AuthService.getCurrentUser(), []);

  useEffect(() => {
    DataService.getChainModels()
      .then((res) => {
        setOptions(res?.data?.items || []);
      })
      .catch((err) => {
        console.log(err);
      });
  }, []);

  const selectedModel = useMemo(
    () => options?.find((o) => o?.id === modelID) || {},
    [options?.length, modelID]
  );

  useEffect(() => {
    setChainName(selectedModel?.chain_name || "");
  }, [selectedModel?.chain_name]);

  const canSubmit = !!file && !!modelID;

  const handleFileChange = (event) => {
    setFile(event.target.files[0]);
  };

  const handleSubmit = (event) => {
    event.preventDefault();
    if (!canSubmit) {
      setOpenAlert(true);
      setMess("Please fill out all required fields.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);
    formData.append("model_id", modelID);
    formData.append("report_name", reportName);
    formData.append("created_by", user?.name || "");
    if (chainName) formData.append("chain_name", chainName);
    formData.append("chain_id", selectedModel?.chain_id);
    formData.append("prev_created_at", selectedModel?.created_at);

    setLoading(true);
    DataService.trainChainModel(formData)
      .then((res) => {
        console.log("Success:", res);
        setResponse({
          report_id: res?.data?.report_id,
          chain_id: res?.data?.chain_id,
        });
        setOpenDialog(true);
      })
      .catch((error) => {
        console.error("Error:", error);
        setOpenAlert(true);
        setMess(error?.response?.data?.error || "Failed to upload data.");
      })
      .finally(() => setLoading(false));
  };

  const handleCancel = () => {
    setMess("");
    setFile(null);
    setChainName("");
    setReportName("");
    setModelID(null);
    setOpenAlert(true);
    setMess("Reset Done!");
  };

  const action = useMemo(
    () => (
      <IconButton
        size="small"
        aria-label="close"
        color="inherit"
        onClick={() => setOpenAlert(false)}
      >
        <X size="20" />
      </IconButton>
    ),
    []
  );

  return (
    <Box
      sx={{
        p: "30px 60px",
        bgcolor: "#121212",
        borderRadius: 2,
        fontFamily: '"Courier New", monospace',
      }}
    >
      <form onSubmit={handleSubmit}>
        <TextField
          required
          fullWidth
          disabled={loading}
          label="Name"
          placeholder="Enter a name"
          value={reportName}
          onChange={(e) => setReportName(e.target.value)}
          sx={{
            mb: 3,
            bgcolor: "background.default",
            color: "text.primary",
            fontFamily: '"Courier New", monospace',
          }}
        />

        <Box sx={{ display: "flex", justifyContent: "space-between", mb: 3 }}>
          <TextField
            required
            disabled={loading || !!selectedModel?.chain_id}
            label="Chain Name"
            value={chainName}
            onChange={(e) => setChainName(e.target.value)}
            sx={{
              flex: 0.4,
              bgcolor: "background.default",
              color: "text.primary",
              fontFamily: '"Courier New", monospace',
            }}
          />
          <Autocomplete
            required
            value={modelID}
            options={options}
            groupBy={(option) => option.report}
            sx={{ flex: 0.6, marginLeft: 1 }}
            renderInput={(params) => (
              <TextField
                {...params}
                label="Model ID"
                sx={{
                  bgcolor: "background.default",
                  color: "text.primary",
                  fontFamily: '"Courier New", monospace',
                }}
              />
            )}
            onChange={(event, newValue) => setModelID(newValue?.value)}
          />
        </Box>

        {!!selectedModel?.target_column && (
          <TextField
            fullWidth
            disabled
            label="Target Column"
            value={selectedModel?.target_column}
            sx={{
              mb: 3,
              bgcolor: "background.default",
              color: "text.primary",
              fontFamily: '"Courier New", monospace',
            }}
          />
        )}

        {!!selectedModel?.feature_columns && (
          <TextField
            fullWidth
            disabled
            label="Feature Columns"
            value={selectedModel?.feature_columns}
            multiline
            rows={4}
            sx={{
              mb: 3,
              bgcolor: "background.default",
              color: "text.primary",
              fontFamily: '"Courier New", monospace',
            }}
          />
        )}

        <Paper
          variant="outlined"
          sx={{
            padding: 2,
            textAlign: "center",
            mb: 3,
            borderStyle: "dashed",
            borderColor: "grey.800",
            bgcolor: "background.paper",
          }}
        >
          <CloudArrowUpFill size="40" color="lightgray" />
          {file ? (
            <Typography
              variant="body1"
              sx={{
                mt: 2,
                color: "text.primary",
                fontFamily: '"Courier New", monospace',
              }}
            >
              Selected file: {file.name}
            </Typography>
          ) : (
            <>
              <Typography
                variant="body1"
                gutterBottom
                sx={{
                  color: "text.primary",
                  fontFamily: '"Courier New", monospace',
                }}
              >
                Select a file or drag and drop here
              </Typography>
              <Typography variant="body2" color="text.secondary">
                CSV file
              </Typography>
            </>
          )}
          <Button
            variant="outlined"
            component="label"
            disabled={loading}
            sx={{
              mt: 2,
              textTransform: "none",
              color: "text.primary",
              borderColor: "text.primary",
              fontFamily: '"Courier New", monospace',
            }}
          >
            Select File
            <input
              type="file"
              hidden
              onChange={handleFileChange}
              required
              disabled={loading}
            />
          </Button>
        </Paper>

        {loading && (
          <Box sx={{ width: "100%" }}>
            <LinearProgress />
          </Box>
        )}

        <Box
          sx={{
            display: "flex",
            justifyContent: "flex-end",
            gap: 1,
            mt: 5,
          }}
        >
          <Button variant="outlined" color="neutral" onClick={handleCancel}>
            Reset
          </Button>
          <Button
            variant="contained"
            color="primary"
            type="submit"
            disabled={loading || !canSubmit}
          >
            Train
          </Button>
        </Box>
      </form>
      <Dialog
        open={openDialog}
        sx={{ bgcolor: "#121212", color: "text.primary" }}
      >
        <DialogTitle
          sx={{
            padding: "30px 40px",
            bgcolor: "#1E1E1E",
            color: "text.primary",
            fontFamily: '"Courier New", monospace',
          }}
        >
          Which report do you want to see?
        </DialogTitle>
        <DialogContent
          sx={{
            padding: "30px 40px",
            display: "flex",
            justifyContent: "space-between",
            bgcolor: "#1E1E1E",
            color: "text.primary",
            fontFamily: '"Courier New", monospace',
          }}
        >
          {response?.report_id ? (
            <Link
              href={`/report/${response?.report_id}`}
              underline="hover"
              color="primary"
            >
              Upload Report
            </Link>
          ) : (
            <Link href="/home" underline="hover" color="primary">
              Upload Report
            </Link>
          )}
          {!!response?.chain_id && (
            <Link
              href={`/chain/${response?.chain_id}`}
              underline="hover"
              color="primary"
            >
              Chain Report
            </Link>
          )}
        </DialogContent>
      </Dialog>
      <Snackbar
        open={openAlert}
        autoHideDuration={6000}
        onClose={() => setOpenAlert(false)}
        message={mess}
        action={action}
      />
    </Box>
  );
};

export default ChainUploadForm;

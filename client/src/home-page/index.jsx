// AdminHomePage.jsx
import React, { useEffect, useMemo, useState } from "react";
import { Typography, Link } from "@mui/material";
import DataService from "../services/data-service";
import AuthService from "../services/auth-service";
import Layout from "../components/Layout"; // Importing your updated Layout component
import ReportList from "../components/ReportList";
import styles from "./styles.module.scss";

const AdminHomePage = () => {
  const user = AuthService.getCurrentUser(); // Get the current user
  const [searchInput, setSearchInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [reports, setReports] = useState([]);
  const [chains, setChains] = useState([]);

  useEffect(() => {
    const fetchReports = async () => {
      setLoading(true);
      try {
        const res = await DataService.getReports();
        setReports(res?.data?.items ?? []);
      } catch (err) {
        console.log(err);
      } finally {
        setLoading(false);
      }
    };

    fetchReports();
  }, []);

  useEffect(() => {
    DataService.getChains()
      .then((res) => {
        setChains(res?.data?.items || []);
      })
      .catch((err) => {
        console.log(err);
      });
  }, []);

  const filteredReports = useMemo(() => {
    if (searchInput?.length > 0) {
      const lowerCaseInput = searchInput.toLowerCase();
      return reports?.filter(
        ({ id, name, created_at, created_by }) =>
          name.toLowerCase().includes(lowerCaseInput) ||
          created_at.toLowerCase().includes(lowerCaseInput) ||
          created_by.toLowerCase().includes(lowerCaseInput) ||
          String(id).toLowerCase().includes(lowerCaseInput) ||
          "upload".includes(lowerCaseInput)
      );
    }
    return [];
  }, [searchInput, reports]);

  const filteredChains = useMemo(() => {
    if (searchInput?.length > 0) {
      const lowerCaseInput = searchInput.toLowerCase();
      return chains?.filter(
        ({ name, type, id }) =>
          name.toLowerCase().includes(lowerCaseInput) ||
          type.toLowerCase().includes(lowerCaseInput) ||
          String(id).toLowerCase().includes(lowerCaseInput) ||
          "chain".includes(lowerCaseInput)
      );
    }
    return [];
  }, [searchInput, chains]);

  return (
    <Layout>
      <div
        className={styles.box}
        style={{ backgroundColor: "#181818", color: "#ffffff" }}
      >
        <Typography
          variant="h5"
          sx={{
            mb: 2,
            color: "#ffffff",
            fontWeight: 600,
            fontFamily: '"Courier New", Courier, monospace',
          }}
        >
          {user?.role
            ? "Admin Dashboard"
            : "Browse Through Our Report Database"}
        </Typography>
        <Typography
          variant="body1"
          sx={{
            mb: 4,
            color: "#d1d1d1",
            fontFamily: '"Courier New", Courier, monospace',
          }}
        >
          {user?.role
            ? "Welcome to the admin dashboard. Here you can manage reports, upload new data, and train the model."
            : "You can browse through the reports and use the search box to find specific reports."}
        </Typography>
        <Typography
          variant="body2"
          sx={{
            mb: 4,
            color: "#d1d1d1",
            fontFamily: '"Courier New", Courier, monospace',
          }}
        >
          Please type in the box below to display the uploaded reports.
        </Typography>
        <input
          className={styles.searchInput}
          type="text"
          placeholder="Search reports..."
          value={searchInput}
          onChange={(e) => setSearchInput(e?.target?.value)}
          style={{
            fontFamily: '"Courier New", Courier, monospace',
            backgroundColor: "#2f2f2f",
            color: "#ffffff",
            border: "1px solid #444",
            padding: "10px",
            borderRadius: "4px",
            width: "100%", // Set width to 100% to match the container
          }}
        />
        {/* You can add more components or functionalities specific to admin here */}
      </div>
      <div
        className={styles.searchList}
        style={{
          color: "#ffffff",
          padding: "10px",
          backgroundColor: "#2f2f2f",
          borderRadius: "4px",
          marginTop: "10px",
        }}
      >
        <div>
          {filteredReports?.map((r) => (
            <Link
              key={r.id}
              href={`/report/${r.id}`}
              display="block"
              underline="hover"
              padding={1}
              sx={{
                fontFamily: '"Courier New", Courier, monospace',
                color: "#d1d1d1",
                "&:hover": { color: "#ffffff" },
              }}
            >
              Upload Report: {r?.name} - {r?.created_at}
            </Link>
          ))}
        </div>
        <div>
          {filteredChains?.map((c) => (
            <Link
              key={c.id}
              href={`/chain/${c.id}`}
              display="block"
              underline="hover"
              padding={1}
              sx={{
                fontFamily: '"Courier New", Courier, monospace',
                color: "#d1d1d1",
                "&:hover": { color: "#ffffff" },
              }}
            >
              Chain Report: {c?.name} - {c?.type}
            </Link>
          ))}
        </div>
      </div>
      <div style={{ flexGrow: 0.75 }} />
      <div
        className={styles.box}
        style={{ backgroundColor: "#181818", color: "#ffffff" }}
      >
        <ReportList loading={loading} reports={reports} />
      </div>
    </Layout>
  );
};

export default AdminHomePage;

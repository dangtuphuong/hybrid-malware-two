// AdminHomePage.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  Container,
  Row,
  Col,
  Form,
  Spinner,
  Alert,
  ListGroup,
} from "react-bootstrap"; // Import React Bootstrap components
import DataService from "../services/data-service";
import AuthService from "../services/auth-service";
import Layout from "../components/Layout"; // Ensure the Layout is imported correctly
import ReportList from "../components/ReportList"; // Reimport the ReportList
import styles from "./styles.module.scss";

const AdminHomePage = () => {
  const user = AuthService.getCurrentUser(); // Get the current user
  const [searchInput, setSearchInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [reports, setReports] = useState([]);

  // Fetch reports from the backend
  useEffect(() => {
    const fetchReports = async () => {
      setLoading(true);
      try {
        const res = await DataService.getReports();
        setReports(res?.data?.items ?? []);
      } catch (err) {
        console.error("Error fetching reports:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchReports();
  }, []);

  // Filter reports based on search input
  const filteredReports = useMemo(() => {
    if (searchInput.length > 0) {
      const lowerCaseInput = searchInput.toLowerCase();
      return reports?.filter(
        ({ id, name, created_at, created_by }) =>
          name.toLowerCase().includes(lowerCaseInput) ||
          created_at.toLowerCase().includes(lowerCaseInput) ||
          created_by.toLowerCase().includes(lowerCaseInput) ||
          String(id).toLowerCase().includes(lowerCaseInput) ||
          "upload".includes(lowerCaseInput)
      );
    }
    return reports; // If no search input, return all reports
  }, [searchInput, reports]);

  const filteredChains = useMemo(() => {
    if (searchInput?.length > 0) {
      const lowerCaseInput = searchInput.toLowerCase();
      return chains?.filter(
        ({ name, type, id }) =>
          name.toLowerCase().includes(lowerCaseInput) ||
          type.toLowerCase().includes(lowerCaseInput) ||
          String(id).toLowerCase().includes(lowerCaseInput) ||
          "chain".includes(lowerCaseInput)
      );
    }
    return [];
  }, [searchInput, chains]);

  return (
    <Layout>
      <Container className={styles.box}>
        <h5
          style={{
            marginBottom: "16px",
            color: "#333",
            fontWeight: 600,
            fontSize: "1.5rem",
          }}
        >
          {user?.role
            ? "Admin Dashboard"
            : "Browse Through Our Report Database"}
        </h5>

        <p style={{ marginBottom: "32px", color: "#666", fontSize: "1.1rem" }}>
          {user?.role
            ? "Welcome to the admin dashboard. Here you can manage reports, upload new data, and train the model."
            : "You can browse through the reports and use the search box to find specific reports."}
        </p>

        {/* Search Input */}
        <Form.Control
          type="text"
          placeholder="Search reports..."
          value={searchInput}
          onChange={(e) => setSearchInput(e?.target?.value)}
        />
        {/* You can add more components or functionalities specific to admin here */}
      </div>
      <div className={styles.searchList}>
        <div>
          {filteredReports?.map((r) => (
            <Link
              key={r.id}
              href={`/report/${r.id}`}
              display="block"
              underline="hover"
              padding={1}
            >
              Upload Report: {r?.name} - {r?.created_at}
            </Link>
          ))}
        </div>
        <div>
          {filteredChains?.map((c) => (
            <Link
              key={c.id}
              href={`/chain/${c.id}`}
              display="block"
              underline="hover"
              padding={1}
            >
              Chain Report: {c?.name} - {c?.type}
            </Link>
          ))}
        </div>
      </Container>

      {/* Report List Component */}
      <div className={styles.box}>
        <ReportList loading={loading} reports={reports} />
      </div>
    </Layout>
  );
};

export default AdminHomePage;
